#!/bin/bash
set -euo pipefail

MAIN_URL="https://raw.githubusercontent.com/youraverageazurecosplay-png/Screen_Switcher/refs/heads/main/Main.py"

printf 'Install folder (default: %s): ' "$HOME/Screen_Switcher"
read -r BASE

if [ -z "$BASE" ]; then
  BASE="$HOME/Screen_Switcher"
fi

TARGET="$BASE/app"

echo "Installing to:"
echo "  Base:  $BASE"
echo "  App:   $TARGET"

mkdir -p "$TARGET"
cd "$TARGET" || exit 1

echo "Creating virtual environment in: $TARGET/.venv"
python3 -m venv .venv

# shellcheck source=/dev/null
source .venv/bin/activate

echo "Upgrading pip and installing dependencies..."
pip install --upgrade pip
pip install pyobjc pynput

echo "Downloading Main.py from:"
echo "  $MAIN_URL"
curl -fsL "$MAIN_URL" -o Main.py

if [ ! -s Main.py ]; then
  echo "ERROR: Main.py is missing or empty in $TARGET"
  echo "       Check that this URL is correct in your browser:"
  echo "       $MAIN_URL"
  exit 1
fi

cd "$BASE" || exit 1

echo "Creating update.sh..."
cat > update.sh << 'EOF'
#!/bin/bash
set -euo pipefail
APP_DIR="$(cd "$(dirname "$0")/app" && pwd)"
cd "$APP_DIR"
source .venv/bin/activate
pip install --upgrade pip pyobjc pynput
curl -fsL "https://raw.githubusercontent.com/youraverageazurecosplay-png/Screen_Switcher/refs/heads/main/Main.py" -o Main.py
echo "Screen_Switcher updated in: $APP_DIR"
EOF
chmod +x update.sh

echo "Creating Run_Screen_Switcher.command..."
cat > Run_Screen_Switcher.command << 'EOF'
#!/bin/bash
APP_DIR="$(cd "$(dirname "$0")/app" && pwd)"
cd "$APP_DIR"
source .venv/bin/activate
python Main.py
EOF
chmod +x Run_Screen_Switcher.command

echo
printf 'Create a shortcut to this folder on your Desktop? [y/N]: '
read -r MAKE_SHORTCUT
MAKE_SHORTCUT=${MAKE_SHORTCUT:-n}

if [ "$MAKE_SHORTCUT" = "y" ] || [ "$MAKE_SHORTCUT" = "Y" ]; then
  DESKTOP="$HOME/Desktop"
  mkdir -p "$DESKTOP"
  LINK_NAME="Bob"
  ln -sfn "$BASE" "$DESKTOP/$LINK_NAME"
  echo "Created shortcut on Desktop: $DESKTOP/$LINK_NAME"
fi

echo
echo "Downloaded Main.py in: $TARGET"
echo "Created updater:  $BASE/update.sh"
echo "Created launcher: $BASE/Run_Screen_Switcher.command"
echo
echo "To run it, double-click 'Run_Screen_Switcher.command' in Finder."
