#!/bin/bash
set -euo pipefail

REPO_USER="youraverageazurecosplay-png"
REPO_NAME="Screen_Switcher"
BRANCH="main"
MAIN_NAME="Screen_Switcher.py"

BASE_DIR="$HOME/Screen_Switcher"
APP_DIR="$BASE_DIR/app"

echo "Installing Screen_Switcher to: $APP_DIR"

mkdir -p "$APP_DIR"
cd "$APP_DIR"

echo "Creating venv in: $APP_DIR/.venv"
python3 -m venv .venv

# shellcheck source=/dev/null
source .venv/bin/activate

echo "Upgrading pip and installing deps..."
pip install --upgrade pip
pip install pyobjc pynput

MAIN_URL="https://raw.githubusercontent.com/$REPO_USER/$REPO_NAME/$BRANCH/$MAIN_NAME"
echo "Downloading main script from:"
echo "  $MAIN_URL"
curl -fsL "$MAIN_URL" -o "$MAIN_NAME"

echo "Checking that $MAIN_NAME exists..."
if [ ! -s "$MAIN_NAME" ]; then
  echo "ERROR: $MAIN_NAME is missing or empty in $APP_DIR"
  echo "       Check that this URL is valid in your browser:"
  echo "       $MAIN_URL"
  exit 1
fi

cd "$BASE_DIR"

echo "Creating update.sh..."
cat > update.sh << 'EOF'
#!/bin/bash
set -euo pipefail
APP_DIR="$(cd "$(dirname "$0")/app" && pwd)"
cd "$APP_DIR"
source .venv/bin/activate
pip install --upgrade pip pyobjc pynput
curl -fsL "https://raw.githubusercontent.com/youraverageazurecosplay-png/Screen_Switcher/main/Screen_Switcher.py" -o Screen_Switcher.py
echo "Screen_Switcher updated in: $APP_DIR"
EOF
chmod +x update.sh

echo "Creating Run_Screen_Switcher.command..."
cat > Run_Screen_Switcher.command << 'EOF'
#!/bin/bash
APP_DIR="$(cd "$(dirname "$0")/app" && pwd)"
cd "$APP_DIR"
source .venv/bin/activate
python Screen_Switcher.py
EOF
chmod +x Run_Screen_Switcher.command

echo
echo "Install complete."
echo "Main script: $APP_DIR/Screen_Switcher.py"
echo "Updater:     $BASE_DIR/update.sh"
echo "Launcher:    $BASE_DIR/Run_Screen_Switcher.command"
echo
echo "To run it, doubleâ€‘click 'Run_Screen_Switcher.command' in Finder."
